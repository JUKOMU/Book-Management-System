{% extends "base-admin.html" %}
{% block title %}查询图书信息{% endblock %}

{% block card %}
<div class="layui-card-header"><h2>发布公告</h2></div>{% endblock %}
{% block body %}
<form class="layui-form" method="post" id="searchForm" enctype="multipart/form-data">
    {{ form.csrf_token }}
    <div class="layui-form-item">
        <div class="layui-inline">
            <div class="layui-row layui-col-space10">
                <div class="layui-col-md6">
                    <label class="layui-form-label">公告标题：</label>
                    <div class="layui-input-inline">
                        {{ form.title(class="layui-input",style="width:250px") }}
                    </div>
                </div>
                <div class="layui-col-md4">
                    {{ form.file(class="layui-input-block", accept=".md,.txt") }}
                </div>
                <div class="layui-col-md2">
                    <div class="layui-input-inline">{{ form.submit(class="layui-btn", id="post") }}</div>
                </div>
            </div>
        </div>

    </div>
</form>

{% endblock %}

{% block script %}
<script>
    $(document).ready(function () {
        $("#li_5").addClass("height-light");
        $('#post').on('click', function () {
            let title = $("#title");
            // 文件元素
            let file = document.querySelector('[type=file]');
            // 通过FormData将文件转成二进制数据
            let formData = new FormData();
            formData.append('title', title.val())
            // 将文件转二进制
            formData.append('file', file.files[0]);
            $.ajax({
                url: "{{ url_for('post_announcement') }}",
                type: "post",
                data: formData,
                cache: false,
                processData: false,
                contentType: false,
                success: function (data) {
                    if (data.code === 200) {
                        layui.use('layer', function () {
                            var layer = layui.layer;
                            layer.msg('发布成功', {time: 1000})
                        });
                        window.open("http://localhost:5000/announcement/"+data.id);
                        title.val("");
                        file.after(file.clone().val(""));
			            file.remove();
                    } else {
                        layui.use('layer', function () {
                            var layer = layui.layer;
                            layer.msg('发布失败', {time: 1000});
                        });
                    }
                },
                fail: function () {
                    layui.use('layer', function () {
                        var layer = layui.layer;
                        layer.msg('发布失败', {time: 1000});
                    });
                }
            });
            return false;
        })
    });
</script>
{% endblock %}

